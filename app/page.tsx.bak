'use client';

import { useState, useEffect, useMemo, useCallback, useRef } from 'react';
import Layout from '@/components/Layout';
import ReactMarkdown from 'react-markdown';
import remarkGfm from 'remark-gfm';
import { getOrgTreeFromDb, getAllOrganizationsFromTree, type OrgNodeData } from '@/lib/orgApi';
import { getThemes, getFocusInitiatives, type Theme, type FocusInitiative } from '@/lib/orgApi';
import dynamic from 'next/dynamic';
import html2canvas from 'html2canvas';
import { extractOrganizationsByDepth, getOrgIdsWithDescendants, type OrgWithDepth, type HierarchyLevel } from './utils/organizationUtils';
import { setupDebugFunctions } from './utils/debugUtils';
import { useDashboardData } from './hooks/useDashboardData';
import { useDashboardCalculations } from './hooks/useDashboardCalculations';

// 開発環境でのみログを有効化するヘルパー関数（パフォーマンス最適化）
const isDev = process.env.NODE_ENV === 'development';
const devLog = (...args: any[]) => {
  if (isDev) {
    console.log(...args);
  }
};
const devWarn = (...args: any[]) => {
  if (isDev) {
    console.warn(...args);
  }
};

// VegaChartを動的インポート（SSRを回避）
const DynamicVegaChart = dynamic(() => import('@/components/VegaChart'), {
  ssr: false,
  loading: () => (
    <div style={{ padding: '40px', textAlign: 'center', color: '#666' }}>
      グラフを読み込み中...
    </div>
  ),
});

// 表示モードの型定義（typeベースのフィルターに変更）
type DashboardViewMode = 'all' | 'organization' | 'company' | 'person';

export default function DashboardPage() {
  const [viewMode, setViewMode] = useState<DashboardViewMode>('all');
  const [selectedTypeFilter, setSelectedTypeFilter] = useState<'all' | 'organization' | 'company' | 'person'>('all');
  const [selectedLevel, setSelectedLevel] = useState<number | null>(null);
  const [selectedThemeId, setSelectedThemeId] = useState<string | null>(null);
  const [showFilterModal, setShowFilterModal] = useState(false);
  const [filteredOrgIds, setFilteredOrgIds] = useState<Set<string>>(new Set());
  const [filteredThemeIds, setFilteredThemeIds] = useState<Set<string>>(new Set());

  // グラフと注力施策一覧を含むコンテナの参照
  const chartAndInitiativesRef = useRef<HTMLDivElement>(null);

  // グローバルデバッグ関数を設定（ブラウザコンソールで使用可能）
  useEffect(() => {
    setupDebugFunctions();
  }, []);

  // データ取得カスタムフック
  const {
    orgTree,
    themes,
    initiatives,
    hierarchyLevels,
    loading,
    error,
  } = useDashboardData({
    selectedTypeFilter,
    selectedLevel,
    setSelectedLevel,
  });

  // 計算ロジックカスタムフック
  const {
    selectedLevelOrgs,
    selectedLevelCompanies,
    level1And2Orgs,
    orgIdsWithDescendants,
    filteredThemes,
    chartData,
    selectedTheme,
    selectedThemeInitiatives,
    selectedThemeCompanyInitiatives,
    filteredInitiativeCount,
  } = useDashboardCalculations({
    selectedTypeFilter,
    hierarchyLevels,
    selectedLevel,
    orgTree,
    filteredOrgIds,
    themes,
    filteredThemeIds,
    initiatives,
    selectedThemeId,
  });

  // Vega-Liteのグラフ仕様を生成（メモ化でパフォーマンス向上）
  const chartSpec = useMemo(() => {
    if (selectedLevel === null) return [];
    const levelData = hierarchyLevels.find(l => l.level === selectedLevel);
    const orgs = levelData?.orgs || [];
    
    // フィルター適用
    if (filteredOrgIds.size > 0) {
      return orgs.filter(org => filteredOrgIds.has(org.id));
    }
    
    return orgs;
  }, [viewMode, selectedLevel, hierarchyLevels, filteredOrgIds]);

  // 表示する事業会社を取得（type='company'の組織を表示）
  const selectedLevelCompanies = useMemo(() => {
    if (selectedTypeFilter !== 'company') return [];
    
    // 選択された階層レベルの組織から、type='company'のものを取得
    const levelData = hierarchyLevels.find(l => l.level === selectedLevel);
    const orgs = levelData?.orgs || [];
    const companies = orgs.filter(org => {
      // orgTreeから実際のtypeを取得
      const findOrg = (node: OrgNodeData, targetId: string): OrgNodeData | null => {
        if (node.id === targetId) return node;
        if (node.children) {
          for (const child of node.children) {
            const found = findOrg(child, targetId);
            if (found) return found;
          }
        }
        return null;
      };
      const actualOrg = orgTree ? findOrg(orgTree, org.id) : null;
      return actualOrg && (actualOrg as any).type === 'company';
    });
    
    // フィルター適用（組織フィルター）
    if (filteredOrgIds.size > 0) {
      return companies.filter(company => {
        return filteredOrgIds.has(company.id);
      });
    }
    
    return companies;
  }, [selectedTypeFilter, hierarchyLevels, selectedLevel, orgTree, filteredOrgIds]);

  // レベル1とレベル2の組織を取得（フィルターボタン用）
  const level1And2Orgs = useMemo(() => {
    const level1Orgs = hierarchyLevels.find(l => l.level === 0)?.orgs || [];
    const level2Orgs = hierarchyLevels.find(l => l.level === 1)?.orgs || [];
    return [...level1Orgs, ...level2Orgs];
  }, [hierarchyLevels]);

  // 選択された階層レベルの組織とその子孫組織IDのマップを取得
  const orgIdsWithDescendants = useMemo(() => {
    if (selectedLevelOrgs.length === 0) return new Map<string, string[]>();
    return getOrgIdsWithDescendants(orgTree, selectedLevelOrgs);
  }, [orgTree, selectedLevelOrgs]);

  // フィルター適用後のテーマリスト
  const filteredThemes = useMemo(() => {
    let result = filteredThemeIds.size === 0 
      ? themes 
      : themes.filter(theme => filteredThemeIds.has(theme.id));
    
    // positionでソート（positionがnullの場合は最後に）
    result = [...result].sort((a, b) => {
      const posA = a.position ?? 999999;
      const posB = b.position ?? 999999;
      if (posA !== posB) return posA - posB;
      // positionが同じ場合は既存のソート順を使用
      const dateA = a.createdAt ? new Date(a.createdAt).getTime() : 0;
      const dateB = b.createdAt ? new Date(b.createdAt).getTime() : 0;
      if (dateA !== dateB) return dateB - dateA; // DESC
      return (a.title || '').localeCompare(b.title || ''); // ASC
    });
    
    return result;
  }, [themes, filteredThemeIds]);

  // テーマ×組織の施策件数を集計（子組織の施策も含める）
  const chartDataOrganization = useMemo(() => {
    if (selectedTypeFilter === 'company' || filteredThemes.length === 0 || selectedLevelOrgs.length === 0) {
      return [];
    }

    const data: Array<{
      theme: string;
      themeId: string;
      organization: string;
      organizationId: string;
      count: number;
    }> = [];

    // 各テーマと各組織の組み合わせで集計
    filteredThemes.forEach(theme => {
      selectedLevelOrgs.forEach(org => {
        // この組織とその子孫組織のIDを取得
        const orgIdsToInclude = orgIdsWithDescendants.get(org.id) || [org.id];

        // この組織とその子孫組織の施策で、このテーマに関連するものをカウント
        const relatedInitiatives = initiatives.filter(init => {
          // 組織IDが対象組織またはその子孫組織に含まれるかチェック
          if (!init.organizationId || !orgIdsToInclude.includes(init.organizationId)) return false;

          // themeId（単一）またはthemeIds（配列）でチェック
          if (theme.id && init.themeId === theme.id) return true;
          if (theme.id && Array.isArray(init.themeIds) && init.themeIds.includes(theme.id)) return true;
          return false;
        });

        data.push({
          theme: theme.title,
          themeId: theme.id,
          organization: org.name,
          organizationId: org.id,
          count: relatedInitiatives.length,
        });
      });
    });

    return data;
  }, [viewMode, filteredThemes, selectedLevelOrgs, initiatives, orgIdsWithDescendants]);

  // テーマ×事業会社の施策件数を集計（type='company'の組織用）
  const chartDataCompany = useMemo(() => {
    if (selectedTypeFilter !== 'company' || filteredThemes.length === 0 || selectedLevelCompanies.length === 0) {
      return [];
    }

    const data: Array<{
      theme: string;
      themeId: string;
      organization: string;
      organizationId: string;
      count: number;
    }> = [];

    filteredThemes.forEach(theme => {
      selectedLevelCompanies.forEach(company => {
        // 事業会社の管理はorganizationsテーブルのtypeカラムで行うため、initiativesから取得
        const relatedInitiatives = initiatives.filter(init => {
          if (init.organizationId !== company.id) return false;
          if (Array.isArray(init.themeIds) && init.themeIds.includes(theme.id)) return true;
          if (init.themeId === theme.id) return true;
          return false;
        });

        const count = relatedInitiatives.length;
        
        // 施策が0件の事業会社は凡例に表示しないため、データから除外
        // テーマは0件でも表示される（X軸のdomain設定で対応）
        if (count > 0) {
          data.push({
            theme: theme.title,
            themeId: theme.id,
            organization: company.name,
            organizationId: company.id,
            count: count,
          });
        }
      });
    });

    return data;
  }, [selectedTypeFilter, filteredThemes, selectedLevelCompanies, initiatives]);

  // 表示モードに応じて適切なデータを返す
  const chartData = useMemo(() => {
    return selectedTypeFilter === 'company' ? chartDataCompany : chartDataOrganization;
  }, [selectedTypeFilter, chartDataOrganization, chartDataCompany]);

  // Vega-Liteのグラフ仕様を生成（メモ化でパフォーマンス向上）
  const chartSpec = useMemo(() => {
    if (chartData.length === 0) return null;

    // 組織ごとの色を自動生成（Vega-Liteのカテゴリカラースキームを使用）
    const organizations = Array.from(new Set(chartData.map(d => d.organization)));
    const maxColors = 20; // Vega-Liteのcategory20スキームは20色

    // レスポンシブ対応: 画面幅に応じて高さを調整
    const isMobile = typeof window !== 'undefined' && window.innerWidth < 768;
    const chartHeight = isMobile ? 400 : 500;

      return {
      $schema: 'https://vega.github.io/schema/vega-lite/v5.json',
      description: 'テーマごとの施策件数を組織別に積み上げて表示',
      width: 'container',
      height: chartHeight,
      padding: { top: 20, right: 20, bottom: 60, left: 60 },
      data: {
        values: chartData,
      },
      layer: [
        // 1. 積み上げ棒グラフ
        {
          mark: {
            type: 'bar',
            tooltip: true,
            cursor: 'pointer',
            cornerRadiusTopLeft: 4,
            cornerRadiusTopRight: 4,
            stroke: '#FFFFFF',
            strokeWidth: 1,
          },
          encoding: {
            x: {
              field: 'theme',
              type: 'ordinal',
              title: 'テーマ',
              scale: {
                // テーマは0件でも表示するため、すべてのテーマをdomainに含める
                domain: filteredThemes.map(t => t.title),
              },
              axis: {
                labelAngle: isMobile ? -90 : -45,
                labelLimit: isMobile ? 50 : 120,
                labelFontSize: isMobile ? 11 : 13,
                labelColor: '#4B5563',
                labelFont: 'var(--font-inter), var(--font-noto), sans-serif',
                titleFontSize: isMobile ? 12 : 14,
                titleFontWeight: '600',
                titleColor: '#1A1A1A',
                titleFont: 'var(--font-inter), var(--font-noto), sans-serif',
                titlePadding: 12,
                domain: true,
                domainColor: '#E5E7EB',
                domainWidth: 1,
                tickSize: 0,
              },
            },
            y: {
              field: 'count',
              type: 'quantitative',
              title: '施策件数',
              axis: {
                grid: false,
                labelFontSize: isMobile ? 11 : 13,
                labelColor: '#6B7280',
                labelFont: 'var(--font-inter), var(--font-noto), sans-serif',
                titleFontSize: isMobile ? 12 : 14,
                titleFontWeight: '600',
                titleColor: '#1A1A1A',
                titleFont: 'var(--font-inter), var(--font-noto), sans-serif',
                titlePadding: 12,
                domain: true,
                domainColor: '#E5E7EB',
                domainWidth: 1,
                tickSize: 0,
              },
              stack: 'zero', // 積み上げグラフ
            },
            color: {
              field: 'organization',
              type: 'nominal',
              title: viewMode === 'organization' ? '組織' : '事業会社',
              scale: {
                scheme: organizations.length <= maxColors ? 'category20' : 'category20b',
              },
              legend: {
                orient: isMobile ? 'bottom' : 'right',
                columns: isMobile ? 2 : 1,
                symbolLimit: organizations.length > 20 ? 50 : undefined,
                labelFontSize: isMobile ? 11 : 13,
                labelColor: '#4B5563',
                labelFont: 'var(--font-inter), var(--font-noto), sans-serif',
                titleFontSize: isMobile ? 12 : 14,
                titleFontWeight: '600',
                titleColor: '#1A1A1A',
                titleFont: 'var(--font-inter), var(--font-noto), sans-serif',
                titlePadding: 8,
                symbolType: 'circle',
                symbolSize: 80,
                padding: 8,
                offset: isMobile ? 0 : 20,
              },
            },
            tooltip: [
              { field: 'theme', type: 'nominal', title: 'テーマ' },
              { field: 'organization', type: 'nominal', title: '組織' },
              { field: 'count', type: 'quantitative', title: '件数', format: 'd' },
            ],
          },
        },
        // 2. テーマごとの合計値を表示するテキストレイヤー
        {
          mark: {
            type: 'text',
            align: 'center',
            baseline: 'bottom',
            dy: -8,
            fontSize: isMobile ? 12 : 14,
            fontWeight: '600',
            fill: '#1A1A1A',
            font: 'var(--font-inter), var(--font-noto), sans-serif',
          },
          encoding: {
            x: {
              field: 'theme',
              type: 'ordinal',
            },
            y: {
              aggregate: 'sum',
              field: 'count',
              type: 'quantitative',
            },
            text: {
              aggregate: 'sum',
              field: 'count',
              type: 'quantitative',
              format: 'd',
            },
            tooltip: [
              { field: 'theme', type: 'nominal', title: 'テーマ' },
              {
                aggregate: 'sum',
                field: 'count',
                type: 'quantitative',
                title: '合計件数',
                format: 'd',
              },
            ],
          },
        },
      ],
      config: {
        view: {
          stroke: 'transparent',
        },
        background: 'transparent',
        axis: {
          labelFont: 'var(--font-inter), var(--font-noto), sans-serif',
          titleFont: 'var(--font-inter), var(--font-noto), sans-serif',
        },
        style: {
          'bar': {
            stroke: '#FFFFFF',
            strokeWidth: 1,
          },
        },
      },
    };
  }, [chartData, viewMode, filteredThemes]);

  // 階層レベル選択ハンドラー（組織モード用）
  const handleLevelChange = useCallback((level: number) => {
    setSelectedLevel(level);
    setSelectedThemeId(null); // 階層レベル変更時に選択をリセット
  }, []);

  // 組織フィルターボタンのハンドラー（事業会社モード用）
  const handleOrgFilterToggle = useCallback((orgId: string) => {
    const newFilteredOrgIds = new Set(filteredOrgIds);
    const isAdding = !newFilteredOrgIds.has(orgId);
    
    if (isAdding) {
      newFilteredOrgIds.add(orgId);
    } else {
      newFilteredOrgIds.delete(orgId);
    }
    
    setFilteredOrgIds(newFilteredOrgIds);
    
    // 事業会社モードの場合、組織に紐づく事業会社も自動的に選択/解除
    // 事業会社の管理はorganizationsテーブルのtypeカラムで行うため、この処理は不要
    // if (viewMode === 'company') {
    //   const linkedCompanyIds = companies
    //     .filter(c => c.organizationId === orgId)
    //     .map(c => c.id);
    //   
    //   const newFilteredCompanyIds = new Set(filteredCompanyIds);
    //   if (isAdding) {
    //     // 組織を選択した場合、その組織に紐づく事業会社も選択
    //     linkedCompanyIds.forEach(companyId => {
    //       newFilteredCompanyIds.add(companyId);
    //     });
    //   } else {
    //     // 組織を解除した場合、その組織に紐づく事業会社も解除
    //     linkedCompanyIds.forEach(companyId => {
    //       newFilteredCompanyIds.delete(companyId);
    //     });
    //   }
    //   setFilteredCompanyIds(newFilteredCompanyIds);
    // }
    
    setSelectedThemeId(null); // フィルター変更時に選択をリセット
  }, [viewMode, filteredOrgIds]);

  // グラフのクリックイベントハンドラー
  const handleChartSignal = useCallback((signalName: string, value: any) => {
    if (signalName === 'clicked_theme' && value && value.themeId) {
      setSelectedThemeId(value.themeId);
    }
  }, []);


  // フィルターが適用されているかチェック
  const hasActiveFilters = useMemo(() => {
    return filteredOrgIds.size > 0 || filteredThemeIds.size > 0;
  }, [filteredOrgIds, filteredThemeIds]);

  // フィルター数の計算
  const filterCount = useMemo(() => {
    return filteredOrgIds.size + filteredThemeIds.size;
  }, [filteredOrgIds, filteredThemeIds]);

  // フィルタークリア関数
  const handleClearFilters = useCallback(() => {
    setFilteredOrgIds(new Set());
    setFilteredThemeIds(new Set());
    // 事業会社の管理はorganizationsテーブルのtypeカラムで行うため、この処理は不要
    // setFilteredCompanyIds(new Set());
  }, []);

  // グラフと注力施策一覧を画像としてダウンロード
  const handleDownloadImage = useCallback(async () => {
    if (!chartAndInitiativesRef.current) {
      alert('ダウンロードするコンテンツが見つかりません。');
      return;
    }

    // ローディング表示（オプション）
    const originalCursor = document.body.style.cursor;
    
    try {
      document.body.style.cursor = 'wait';

      // html2canvasでキャプチャ
      const canvas = await html2canvas(chartAndInitiativesRef.current, {
        backgroundColor: '#ffffff',
        scale: 2, // 高解像度
        useCORS: true,
        logging: false,
        scrollX: 0,
        scrollY: 0,
      });

      // PNGとしてダウンロード
      canvas.toBlob((blob) => {
        if (!blob) {
          alert('画像の生成に失敗しました。');
          document.body.style.cursor = originalCursor;
          return;
        }

        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        const themeTitle = selectedTheme?.title || 'ダッシュボード';
        const sanitizedTitle = themeTitle.replace(/[<>:"/\\|?*]/g, '_'); // ファイル名に使えない文字を置換
        link.href = url;
        link.download = `${sanitizedTitle}_グラフと注力施策一覧_${Date.now()}.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        setTimeout(() => {
          URL.revokeObjectURL(url);
        }, 100);

        document.body.style.cursor = originalCursor;
      }, 'image/png', 1.0);
    } catch (error) {
      console.error('画像ダウンロードエラー:', error);
      alert('画像のダウンロードに失敗しました。');
      document.body.style.cursor = originalCursor;
    }
  }, [selectedTheme]);

  if (loading) {
    return (
      <Layout>
        <div className="card" style={{ padding: '40px', textAlign: 'center' }}>
          <p>データを読み込み中...</p>
        </div>
      </Layout>
    );
  }

  if (error) {
    return (
      <Layout>
        <div className="card" style={{ padding: '20px' }}>
          <h2 style={{ marginBottom: '8px' }}>ダッシュボード</h2>
          <div style={{
            padding: '16px',
            backgroundColor: '#FEF2F2',
            border: '1.5px solid #FCA5A5',
            borderRadius: '8px',
            color: '#991B1B',
            fontSize: '14px',
          }}>
            <strong>エラー:</strong> {error}
          </div>
        </div>
      </Layout>
    );
  }

  return (
    <Layout>
      <div className="card" style={{ padding: '32px' }}>
        {/* ヘッダー */}
        <div style={{ marginBottom: '32px' }}>
          <h2 style={{
            marginBottom: '8px',
            fontSize: '24px',
            fontWeight: '600',
            color: '#1A1A1A',
          }}>
            ダッシュボード
          </h2>
          <p style={{
            marginBottom: 0,
            fontSize: '14px',
            color: '#808080',
          }}>
            テーマごとの施策件数を{selectedTypeFilter === 'all' ? 'すべて' : selectedTypeFilter === 'company' ? '事業会社' : selectedTypeFilter === 'person' ? '個人' : '組織'}別に分析します
          </p>
        </div>

        {/* 表示モード選択ボタン */}
        <div style={{ marginBottom: '16px' }}>
          <div style={{
            display: 'flex',
            gap: '8px',
            alignItems: 'center',
          }}>
            <button
              type="button"
              onClick={() => {
                setViewMode('all');
                setSelectedTypeFilter('all');
              }}
              style={{
                padding: '10px 20px',
                fontSize: '14px',
                fontWeight: selectedTypeFilter === 'all' ? '600' : '400',
                color: selectedTypeFilter === 'all' ? '#4262FF' : '#1A1A1A',
                backgroundColor: selectedTypeFilter === 'all' ? '#F0F4FF' : '#FFFFFF',
                border: selectedTypeFilter === 'all' ? '2px solid #4262FF' : '1.5px solid #E0E0E0',
                borderRadius: '8px',
                cursor: 'pointer',
                transition: 'all 150ms',
              }}
            >
              すべて
            </button>
            <button
              type="button"
              onClick={() => {
                setViewMode('organization');
                setSelectedTypeFilter('organization');
              }}
              style={{
                padding: '10px 20px',
                fontSize: '14px',
                fontWeight: selectedTypeFilter === 'organization' ? '600' : '400',
                color: selectedTypeFilter === 'organization' ? '#4262FF' : '#1A1A1A',
                backgroundColor: selectedTypeFilter === 'organization' ? '#F0F4FF' : '#FFFFFF',
                border: selectedTypeFilter === 'organization' ? '2px solid #4262FF' : '1.5px solid #E0E0E0',
                borderRadius: '8px',
                cursor: 'pointer',
                transition: 'all 150ms',
              }}
            >
              組織
            </button>
            <button
              type="button"
              onClick={() => {
                setViewMode('company');
                setSelectedTypeFilter('company');
              }}
              style={{
                padding: '10px 20px',
                fontSize: '14px',
                fontWeight: selectedTypeFilter === 'company' ? '600' : '400',
                color: selectedTypeFilter === 'company' ? '#10B981' : '#1A1A1A',
                backgroundColor: selectedTypeFilter === 'company' ? '#ECFDF5' : '#FFFFFF',
                border: selectedTypeFilter === 'company' ? '2px solid #10B981' : '1.5px solid #E0E0E0',
                borderRadius: '8px',
                cursor: 'pointer',
                transition: 'all 150ms',
              }}
            >
              事業会社
            </button>
            <button
              type="button"
              onClick={() => {
                setViewMode('person');
                setSelectedTypeFilter('person');
              }}
              style={{
                padding: '10px 20px',
                fontSize: '14px',
                fontWeight: selectedTypeFilter === 'person' ? '600' : '400',
                color: selectedTypeFilter === 'person' ? '#A855F7' : '#1A1A1A',
                backgroundColor: selectedTypeFilter === 'person' ? '#F5F3FF' : '#FFFFFF',
                border: selectedTypeFilter === 'person' ? '2px solid #A855F7' : '1.5px solid #E0E0E0',
                borderRadius: '8px',
                cursor: 'pointer',
                transition: 'all 150ms',
              }}
            >
              個人
            </button>
          </div>
        </div>

        {/* 事業会社モード: 組織フィルターボタン（レベル1とレベル2） */}
        {viewMode === 'company' && (
          <div style={{ marginBottom: '24px' }}>
            <div style={{
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'flex-start',
              marginBottom: '12px',
            }}>
              <label style={{
                fontSize: '14px',
                fontWeight: '500',
                color: '#1A1A1A',
              }}>
                組織でフィルター（事業会社に紐づけられている組織）
              </label>
              <div style={{
                display: 'flex',
                alignItems: 'center',
                gap: '8px',
              }}>
                <button
                  type="button"
                  onClick={() => setShowFilterModal(true)}
                  style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '6px',
                    padding: '8px 16px',
                    fontSize: '14px',
                    fontWeight: '500',
                    color: hasActiveFilters ? '#4262FF' : '#6B7280',
                    backgroundColor: hasActiveFilters ? '#F0F4FF' : '#FFFFFF',
                    border: hasActiveFilters ? '2px solid #4262FF' : '1.5px solid #E0E0E0',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    transition: 'all 150ms',
                  }}
                >
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path
                      d="M2 4h12M4 8h8M6 12h4"
                      stroke="currentColor"
                      strokeWidth="2"
                      strokeLinecap="round"
                    />
                  </svg>
                  フィルター
                  {hasActiveFilters && (
                    <span style={{
                      backgroundColor: '#4262FF',
                      color: '#FFFFFF',
                      borderRadius: '10px',
                      padding: '2px 6px',
                      fontSize: '11px',
                      fontWeight: '600',
                      minWidth: '18px',
                      textAlign: 'center',
                    }}>
                      {filterCount}
                    </span>
                  )}
                </button>
                {hasActiveFilters && (
                  <button
                    type="button"
                    onClick={handleClearFilters}
                    style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: '6px',
                      padding: '8px 16px',
                      fontSize: '14px',
                      fontWeight: '500',
                      color: '#6B7280',
                      backgroundColor: '#FFFFFF',
                      border: '1.5px solid #E0E0E0',
                      borderRadius: '8px',
                      cursor: 'pointer',
                      transition: 'all 150ms',
                    }}
                    onMouseEnter={(e) => {
                      e.currentTarget.style.borderColor = '#C4C4C4';
                      e.currentTarget.style.backgroundColor = '#FAFAFA';
                    }}
                    onMouseLeave={(e) => {
                      e.currentTarget.style.borderColor = '#E0E0E0';
                      e.currentTarget.style.backgroundColor = '#FFFFFF';
                    }}
                  >
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                      <path
                        d="M12 4L4 12M4 4l8 8"
                        stroke="currentColor"
                        strokeWidth="2"
                        strokeLinecap="round"
                      />
                    </svg>
                    クリア
                  </button>
                )}
              </div>
            </div>
            {level1And2Orgs.length > 0 && (
              <div style={{
                display: 'flex',
                flexWrap: 'wrap',
                gap: '8px',
              }}>
                {level1And2Orgs.map(org => {
                  const isSelected = filteredOrgIds.has(org.id);
                  return (
                    <button
                      key={org.id}
                      type="button"
                      onClick={() => handleOrgFilterToggle(org.id)}
                      style={{
                        padding: '10px 16px',
                        fontSize: '14px',
                        fontWeight: isSelected ? '600' : '400',
                        color: isSelected ? '#4262FF' : '#1A1A1A',
                        backgroundColor: isSelected ? '#F0F4FF' : '#FFFFFF',
                        border: isSelected ? '2px solid #4262FF' : '1.5px solid #E0E0E0',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        transition: 'all 150ms',
                      }}
                    >
                      {org.name}
                    </button>
                  );
                })}
              </div>
            )}
          </div>
        )}

        {/* 組織モード: 階層レベル選択とフィルター */}
        {hierarchyLevels.length > 0 && (
          <div style={{ marginBottom: '24px' }}>
            <div style={{
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'flex-start',
              marginBottom: '12px',
            }}>
              <label style={{
                fontSize: '14px',
                fontWeight: '500',
                color: '#1A1A1A',
              }}>
                階層レベルを選択
              </label>
              <div style={{
                display: 'flex',
                alignItems: 'center',
                gap: '8px',
              }}>
                <button
                  type="button"
                  onClick={() => setShowFilterModal(true)}
                  style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '6px',
                    padding: '8px 16px',
                    fontSize: '14px',
                    fontWeight: '500',
                    color: hasActiveFilters ? '#4262FF' : '#6B7280',
                    backgroundColor: hasActiveFilters ? '#F0F4FF' : '#FFFFFF',
                    border: hasActiveFilters ? '2px solid #4262FF' : '1.5px solid #E0E0E0',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    transition: 'all 150ms',
                  }}
                >
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path
                      d="M2 4h12M4 8h8M6 12h4"
                      stroke="currentColor"
                      strokeWidth="2"
                      strokeLinecap="round"
                    />
                  </svg>
                  フィルター
                  {hasActiveFilters && (
                    <span style={{
                      backgroundColor: '#4262FF',
                      color: '#FFFFFF',
                      borderRadius: '10px',
                      padding: '2px 6px',
                      fontSize: '11px',
                      fontWeight: '600',
                      minWidth: '18px',
                      textAlign: 'center',
                    }}>
                      {filterCount}
                    </span>
                  )}
                </button>
                {hasActiveFilters && (
                  <button
                    type="button"
                    onClick={handleClearFilters}
                    style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: '6px',
                      padding: '8px 16px',
                      fontSize: '14px',
                      fontWeight: '500',
                      color: '#6B7280',
                      backgroundColor: '#FFFFFF',
                      border: '1.5px solid #E0E0E0',
                      borderRadius: '8px',
                      cursor: 'pointer',
                      transition: 'all 150ms',
                    }}
                    onMouseEnter={(e) => {
                      e.currentTarget.style.borderColor = '#C4C4C4';
                      e.currentTarget.style.backgroundColor = '#FAFAFA';
                    }}
                    onMouseLeave={(e) => {
                      e.currentTarget.style.borderColor = '#E0E0E0';
                      e.currentTarget.style.backgroundColor = '#FFFFFF';
                    }}
                  >
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                      <path
                        d="M12 4L4 12M4 4l8 8"
                        stroke="currentColor"
                        strokeWidth="2"
                        strokeLinecap="round"
                      />
                    </svg>
                    クリア
                  </button>
                )}
              </div>
            </div>
            <div style={{
              display: 'flex',
              flexWrap: 'wrap',
              gap: '8px',
            }}>
              {hierarchyLevels.map(levelData => (
                <button
                  key={levelData.level}
                  type="button"
                  onClick={() => handleLevelChange(levelData.level)}
                  style={{
                    padding: '10px 16px',
                    fontSize: '14px',
                    fontWeight: selectedLevel === levelData.level ? '600' : '400',
                    color: selectedLevel === levelData.level ? '#4262FF' : '#1A1A1A',
                    backgroundColor: selectedLevel === levelData.level ? '#F0F4FF' : '#FFFFFF',
                    border: selectedLevel === levelData.level ? '2px solid #4262FF' : '1.5px solid #E0E0E0',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    transition: 'all 150ms',
                  }}
                >
                  レベル{levelData.level} ({levelData.orgs.length}組織)
                </button>
              ))}
            </div>
          </div>
        )}

        {/* エラーメッセージ */}
        {themes.length === 0 && (
          <div style={{
            padding: '16px',
            backgroundColor: '#FFFBF0',
            border: '1.5px solid #FCD34D',
            borderRadius: '8px',
            color: '#92400E',
            fontSize: '14px',
            marginBottom: '24px',
          }}>
            テーマが登録されていません。テーマを追加してください。
          </div>
        )}

        {viewMode === 'organization' && selectedLevelOrgs.length === 0 && selectedLevel !== null && (
          <div style={{
            padding: '16px',
            backgroundColor: '#FFFBF0',
            border: '1.5px solid #FCD34D',
            borderRadius: '8px',
            color: '#92400E',
            fontSize: '14px',
            marginBottom: '24px',
          }}>
            選択された階層レベルに組織が存在しません。
          </div>
        )}

        {selectedTypeFilter === 'company' && selectedLevelCompanies.length === 0 && (
          <div style={{
            padding: '16px',
            backgroundColor: '#FFFBF0',
            border: '1.5px solid #FCD34D',
            borderRadius: '8px',
            color: '#92400E',
            fontSize: '14px',
            marginBottom: '24px',
          }}>
            事業会社が存在しません。
          </div>
        )}

        {/* 統計情報カード（グラフの上） */}
        {chartData.length > 0 && (
          <div style={{
            display: 'grid',
            gridTemplateColumns: typeof window !== 'undefined' && window.innerWidth < 768 
              ? '1fr' 
              : 'repeat(3, 1fr)',
            gap: typeof window !== 'undefined' && window.innerWidth < 768 ? '16px' : '20px',
            marginBottom: '32px',
          }}>
            {/* テーマ数カード */}
            <div style={{
              padding: '24px',
              backgroundColor: '#FFFFFF',
              border: '1px solid #E5E7EB',
              borderRadius: '12px',
              boxShadow: '0 2px 8px rgba(0, 0, 0, 0.04)',
              transition: 'all 0.2s ease',
              position: 'relative',
              overflow: 'hidden',
            }}
            onMouseEnter={(e) => {
              e.currentTarget.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.08)';
              e.currentTarget.style.transform = 'translateY(-2px)';
            }}
            onMouseLeave={(e) => {
              e.currentTarget.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.04)';
              e.currentTarget.style.transform = 'translateY(0)';
            }}
            >
              <div style={{
                position: 'absolute',
                top: 0,
                right: 0,
                width: '60px',
                height: '60px',
                background: 'linear-gradient(135deg, #F0F4FF 0%, #E0E8FF 100%)',
                borderRadius: '0 12px 0 60px',
                opacity: 0.5,
              }} />
              <div style={{
                fontSize: '13px',
                color: '#6B7280',
                marginBottom: '12px',
                fontWeight: '500',
                letterSpacing: '0.02em',
                textTransform: 'uppercase',
                position: 'relative',
                zIndex: 1,
              }}>
                テーマ数
              </div>
              <div style={{
                fontSize: '40px',
                fontWeight: '700',
                color: '#1A1A1A',
                lineHeight: '1',
                marginBottom: '4px',
                position: 'relative',
                zIndex: 1,
                fontFamily: 'var(--font-inter), -apple-system, BlinkMacSystemFont, sans-serif',
              }}>
                {filteredThemes.length}
              </div>
              <div style={{
                fontSize: '13px',
                color: '#9CA3AF',
                fontWeight: '400',
                position: 'relative',
                zIndex: 1,
              }}>
                件のテーマ
                {filteredThemeIds.size > 0 && (
                  <span style={{
                    fontSize: '11px',
                    color: '#4262FF',
                    marginLeft: '4px',
                  }}>
                    (フィルター適用中)
                  </span>
                )}
              </div>
            </div>

            {/* 組織数/事業会社数カード */}
            <div style={{
              padding: '24px',
              backgroundColor: '#FFFFFF',
              border: '1px solid #E5E7EB',
              borderRadius: '12px',
              boxShadow: '0 2px 8px rgba(0, 0, 0, 0.04)',
              transition: 'all 0.2s ease',
              position: 'relative',
              overflow: 'hidden',
            }}
            onMouseEnter={(e) => {
              e.currentTarget.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.08)';
              e.currentTarget.style.transform = 'translateY(-2px)';
            }}
            onMouseLeave={(e) => {
              e.currentTarget.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.04)';
              e.currentTarget.style.transform = 'translateY(0)';
            }}
            >
              <div style={{
                position: 'absolute',
                top: 0,
                right: 0,
                width: '60px',
                height: '60px',
                background: 'linear-gradient(135deg, #F0FDF4 0%, #DCFCE7 100%)',
                borderRadius: '0 12px 0 60px',
                opacity: 0.5,
              }} />
              <div style={{
                fontSize: '13px',
                color: '#6B7280',
                marginBottom: '12px',
                fontWeight: '500',
                letterSpacing: '0.02em',
                textTransform: 'uppercase',
                position: 'relative',
                zIndex: 1,
              }}>
                {selectedTypeFilter === 'company' ? '事業会社数' : selectedTypeFilter === 'person' ? '個人数' : '組織数'}
              </div>
              <div style={{
                fontSize: '40px',
                fontWeight: '700',
                color: '#1A1A1A',
                lineHeight: '1',
                marginBottom: '4px',
                position: 'relative',
                zIndex: 1,
                fontFamily: 'var(--font-inter), -apple-system, BlinkMacSystemFont, sans-serif',
              }}>
                {selectedTypeFilter === 'company' ? selectedLevelCompanies.length : selectedLevelOrgs.length}
              </div>
              <div style={{
                fontSize: '13px',
                color: '#9CA3AF',
                fontWeight: '400',
                position: 'relative',
                zIndex: 1,
              }}>
                件の{selectedTypeFilter === 'company' ? '事業会社' : selectedTypeFilter === 'person' ? '個人' : '組織'}
                {filteredOrgIds.size > 0 && (
                  <span style={{
                    fontSize: '11px',
                    color: '#4262FF',
                    marginLeft: '4px',
                  }}>
                    (フィルター適用中)
                  </span>
                )}
              </div>
            </div>

            {/* 施策総数カード */}
            <div style={{
              padding: '24px',
              backgroundColor: '#FFFFFF',
              border: '1px solid #E5E7EB',
              borderRadius: '12px',
              boxShadow: '0 2px 8px rgba(0, 0, 0, 0.04)',
              transition: 'all 0.2s ease',
              position: 'relative',
              overflow: 'hidden',
            }}
            onMouseEnter={(e) => {
              e.currentTarget.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.08)';
              e.currentTarget.style.transform = 'translateY(-2px)';
            }}
            onMouseLeave={(e) => {
              e.currentTarget.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.04)';
              e.currentTarget.style.transform = 'translateY(0)';
            }}
            >
              <div style={{
                position: 'absolute',
                top: 0,
                right: 0,
                width: '60px',
                height: '60px',
                background: 'linear-gradient(135deg, #FEF3F2 0%, #FEE2E2 100%)',
                borderRadius: '0 12px 0 60px',
                opacity: 0.5,
              }} />
              <div style={{
                fontSize: '13px',
                color: '#6B7280',
                marginBottom: '12px',
                fontWeight: '500',
                letterSpacing: '0.02em',
                textTransform: 'uppercase',
                position: 'relative',
                zIndex: 1,
              }}>
                施策総数
              </div>
              <div style={{
                fontSize: '40px',
                fontWeight: '700',
                color: '#1A1A1A',
                lineHeight: '1',
                marginBottom: '4px',
                position: 'relative',
                zIndex: 1,
                fontFamily: 'var(--font-inter), -apple-system, BlinkMacSystemFont, sans-serif',
              }}>
                {filteredInitiativeCount}
              </div>
              <div style={{
                fontSize: '13px',
                color: '#9CA3AF',
                fontWeight: '400',
                position: 'relative',
                zIndex: 1,
              }}>
                件の施策
                {(filteredOrgIds.size > 0 || filteredThemeIds.size > 0) && (
                  <span style={{
                    fontSize: '11px',
                    color: '#4262FF',
                    marginLeft: '4px',
                  }}>
                    (フィルター適用中)
                  </span>
                )}
              </div>
            </div>
          </div>
        )}

        {/* グラフと注力施策一覧を含むコンテナ（画像ダウンロード用） */}
        <div ref={chartAndInitiativesRef}>
          {/* グラフ */}
          {chartSpec && chartData.length > 0 ? (
            <div style={{
              marginBottom: '32px',
              width: '100%',
              overflowX: 'auto',
            }}>
              <div style={{
                backgroundColor: '#FFFFFF',
                border: '1px solid #E5E7EB',
                borderRadius: '12px',
                boxShadow: '0 2px 8px rgba(0, 0, 0, 0.04)',
                padding: '24px',
                overflow: 'hidden',
              }}>
                <div style={{
                  marginBottom: '20px',
                  paddingBottom: '16px',
                  borderBottom: '1px solid #F3F4F6',
                }}>
                  <h3 style={{
                    fontSize: '18px',
                    fontWeight: '600',
                    color: '#1A1A1A',
                    margin: 0,
                    fontFamily: 'var(--font-inter), var(--font-noto), sans-serif',
                  }}>
                    テーマ別施策件数
                  </h3>
                  <p style={{
                    fontSize: '13px',
                    color: '#6B7280',
                    margin: '4px 0 0 0',
                    fontFamily: 'var(--font-inter), var(--font-noto), sans-serif',
                  }}>
                    {selectedTypeFilter === 'company' ? '事業会社別' : selectedTypeFilter === 'person' ? '個人別' : `階層レベル${selectedLevel}`}
                  </p>
                </div>
                <DynamicVegaChart
                  spec={chartSpec}
                  language="vega-lite"
                  onSignal={handleChartSignal}
                  chartData={chartData}
                  noBorder={true}
                />
              </div>
            </div>
          ) : (
            themes.length > 0 && 
            ((viewMode === 'organization' && selectedLevelOrgs.length > 0) || 
             (selectedTypeFilter === 'company' && selectedLevelCompanies.length > 0)) && (
              <div style={{
                padding: '60px 20px',
                textAlign: 'center',
                color: '#808080',
                fontSize: '14px',
                backgroundColor: '#FAFAFA',
                borderRadius: '8px',
                border: '1px dashed #E0E0E0',
              }}>
                施策が登録されていません。
              </div>
            )
          )}

          {/* 選択されたテーマの注力施策カード */}
          {chartData.length > 0 && (
            <div style={{
              marginTop: '24px',
              padding: '16px',
              backgroundColor: '#F9FAFB',
              borderRadius: '8px',
              fontSize: '14px',
            }}>
            {/* 選択されたテーマの注力施策カード - 組織モード */}
            {selectedTypeFilter !== 'company' && selectedTheme && selectedThemeInitiatives.length > 0 && (
              <div style={{ marginTop: '24px', borderTop: '1px solid #E5E7EB', paddingTop: '16px' }}>
                <div style={{ fontWeight: '600', marginBottom: '12px', fontSize: '16px', color: '#1A1A1A' }}>
                  「{selectedTheme.title}」の注力施策 ({selectedThemeInitiatives.length}件)
                </div>
                <div style={{
                  display: 'grid',
                  gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))',
                  gap: '16px',
                }}>
                  {selectedThemeInitiatives.map(initiative => {
                    // 組織名を取得
                    const orgName = selectedLevelOrgs.find(o => {
                      const orgIds = orgIdsWithDescendants.get(o.id) || [];
                      return initiative.organizationId && orgIds.includes(initiative.organizationId);
                    })?.name || '不明な組織';

                    return (
                      <div
                        key={initiative.id}
                        style={{
                          padding: '16px',
                          backgroundColor: '#FFFFFF',
                          border: '1px solid #E5E7EB',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          transition: 'all 150ms',
                        }}
                        onMouseEnter={(e) => {
                          e.currentTarget.style.borderColor = '#4262FF';
                          e.currentTarget.style.boxShadow = '0 2px 8px rgba(66, 98, 255, 0.1)';
                        }}
                        onMouseLeave={(e) => {
                          e.currentTarget.style.borderColor = '#E5E7EB';
                          e.currentTarget.style.boxShadow = 'none';
                        }}
                        onClick={() => {
                          // 注力施策詳細ページに遷移
                          window.location.href = `/organization/initiative?organizationId=${initiative.organizationId}&initiativeId=${initiative.id}`;
                        }}
                      >
                        <div style={{
                          fontSize: '12px',
                          color: '#6B7280',
                          marginBottom: '8px',
                        }}>
                          {orgName}
                        </div>
                        <div style={{
                          fontSize: '16px',
                          fontWeight: '600',
                          color: '#1A1A1A',
                          marginBottom: '8px',
                          lineHeight: '1.4',
                        }}>
                          {initiative.title}
                        </div>
                        {initiative.description && (
                          <div style={{
                            fontSize: '11px',
                            color: '#4B5563',
                            lineHeight: '1.4',
                            overflow: 'hidden',
                            textOverflow: 'ellipsis',
                            whiteSpace: 'nowrap',
                          }}>
                            <ReactMarkdown 
                              remarkPlugins={[remarkGfm]} 
                              components={{
                                a: ({ node, ...props }: any) => (
                                  <a
                                    {...props}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    style={{ color: '#4262FF', textDecoration: 'underline', fontSize: 'inherit' }}
                                  />
                                ),
                                p: ({ node, ...props }: any) => (
                                  <p {...props} style={{ margin: 0, marginBottom: 0, fontSize: 'inherit', display: 'inline' }} />
                                ),
                                h1: ({ node, ...props }: any) => (
                                  <span {...props} style={{ fontSize: 'inherit', fontWeight: 600 }} />
                                ),
                                h2: ({ node, ...props }: any) => (
                                  <span {...props} style={{ fontSize: 'inherit', fontWeight: 600 }} />
                                ),
                                h3: ({ node, ...props }: any) => (
                                  <span {...props} style={{ fontSize: 'inherit', fontWeight: 600 }} />
                                ),
                                h4: ({ node, ...props }: any) => (
                                  <span {...props} style={{ fontSize: 'inherit', fontWeight: 600 }} />
                                ),
                                h5: ({ node, ...props }: any) => (
                                  <span {...props} style={{ fontSize: 'inherit', fontWeight: 600 }} />
                                ),
                                h6: ({ node, ...props }: any) => (
                                  <span {...props} style={{ fontSize: 'inherit', fontWeight: 600 }} />
                                ),
                                strong: ({ node, ...props }: any) => (
                                  <strong {...props} style={{ fontSize: 'inherit', fontWeight: 600 }} />
                                ),
                                em: ({ node, ...props }: any) => (
                                  <em {...props} style={{ fontSize: 'inherit', fontStyle: 'italic' }} />
                                ),
                                ul: ({ node, ...props }: any) => (
                                  <span {...props} style={{ fontSize: 'inherit' }} />
                                ),
                                ol: ({ node, ...props }: any) => (
                                  <span {...props} style={{ fontSize: 'inherit' }} />
                                ),
                                li: ({ node, ...props }: any) => (
                                  <span {...props} style={{ fontSize: 'inherit' }} />
                                ),
                                code: ({ node, ...props }: any) => (
                                  <code {...props} style={{ fontSize: 'inherit', backgroundColor: '#F3F4F6', padding: '2px 4px', borderRadius: '3px' }} />
                                ),
                                blockquote: ({ node, ...props }: any) => (
                                  <span {...props} style={{ fontSize: 'inherit' }} />
                                ),
                              }}
                            >
                              {initiative.description.replace(/\n/g, ' ').replace(/\s+/g, ' ')}
                            </ReactMarkdown>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            {/* 選択されたテーマの注力施策カード - 事業会社モード */}
            {selectedTypeFilter === 'company' && selectedTheme && selectedThemeCompanyInitiatives.length > 0 && (
              <div style={{ marginTop: '24px', borderTop: '1px solid #E5E7EB', paddingTop: '16px' }}>
                <div style={{ fontWeight: '600', marginBottom: '12px', fontSize: '16px', color: '#1A1A1A' }}>
                  「{selectedTheme.title}」の注力施策 ({selectedThemeCompanyInitiatives.length}件)
                </div>
                <div style={{
                  display: 'grid',
                  gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))',
                  gap: '16px',
                }}>
                  {selectedThemeCompanyInitiatives.map(initiative => {
                    // 事業会社名を取得（orgTreeから取得）
                    const findOrg = (node: OrgNodeData, targetId: string): OrgNodeData | null => {
                      if (node.id === targetId) return node;
                      if (node.children) {
                        for (const child of node.children) {
                          const found = findOrg(child, targetId);
                          if (found) return found;
                        }
                      }
                      return null;
                    };
                    const companyOrg = orgTree ? findOrg(orgTree, initiative.organizationId || '') : null;
                    const companyName = companyOrg?.name || companyOrg?.title || '不明な事業会社';

                    return (
                      <div
                        key={initiative.id}
                        style={{
                          padding: '16px',
                          backgroundColor: '#FFFFFF',
                          border: '1px solid #E5E7EB',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          transition: 'all 150ms',
                        }}
                        onMouseEnter={(e) => {
                          e.currentTarget.style.borderColor = '#4262FF';
                          e.currentTarget.style.boxShadow = '0 2px 8px rgba(66, 98, 255, 0.1)';
                        }}
                        onMouseLeave={(e) => {
                          e.currentTarget.style.borderColor = '#E5E7EB';
                          e.currentTarget.style.boxShadow = 'none';
                        }}
                        onClick={() => {
                          // 注力施策詳細ページに遷移（/organization/initiativeページを使用）
                          window.location.href = `/organization/initiative?organizationId=${initiative.organizationId}&initiativeId=${initiative.id}`;
                        }}
                      >
                        <div style={{
                          fontSize: '12px',
                          color: '#6B7280',
                          marginBottom: '8px',
                        }}>
                          {companyName}
                        </div>
                        <div style={{
                          fontSize: '16px',
                          fontWeight: '600',
                          color: '#1A1A1A',
                          lineHeight: '1.4',
                        }}>
                          {initiative.title}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            {selectedTheme && 
             ((selectedTypeFilter !== 'company' && selectedThemeInitiatives.length === 0) ||
              (selectedTypeFilter === 'company' && selectedThemeCompanyInitiatives.length === 0)) && (
              <div style={{
                marginTop: '24px',
                borderTop: '1px solid #E5E7EB',
                paddingTop: '16px',
                color: '#6B7280',
                fontSize: '14px',
              }}>
                「{selectedTheme.title}」に関連する注力施策はありません。
              </div>
            )}
          </div>
          )}

          {/* ダウンロードボタン（テーマが選択されている時のみ表示） */}
          {selectedTheme && (
            <div style={{
              marginTop: '16px',
              display: 'flex',
              justifyContent: 'flex-end',
            }}>
              <button
                type="button"
                onClick={handleDownloadImage}
                title="グラフと注力施策一覧を画像としてダウンロード"
                style={{
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  width: '32px',
                  height: '32px',
                  padding: 0,
                  fontSize: '14px',
                  color: '#6B7280',
                  backgroundColor: 'transparent',
                  border: '1px solid #E5E7EB',
                  borderRadius: '6px',
                  cursor: 'pointer',
                  transition: 'all 150ms',
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.backgroundColor = '#F3F4F6';
                  e.currentTarget.style.borderColor = '#D1D5DB';
                  e.currentTarget.style.color = '#374151';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.backgroundColor = 'transparent';
                  e.currentTarget.style.borderColor = '#E5E7EB';
                  e.currentTarget.style.color = '#6B7280';
                }}
              >
                <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
                  <path
                    d="M10 2.5V12.5M10 12.5L6.25 8.75M10 12.5L13.75 8.75M2.5 15V16.25C2.5 16.913 3.037 17.5 3.75 17.5H16.25C16.963 17.5 17.5 16.913 17.5 16.25V15"
                    stroke="currentColor"
                    strokeWidth="1.5"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                  />
                </svg>
              </button>
            </div>
          )}
        </div>

        {/* フィルターモーダル */}
        {showFilterModal && (
          <div
            style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              backgroundColor: 'rgba(0, 0, 0, 0.5)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              zIndex: 1000,
            }}
            onClick={() => setShowFilterModal(false)}
          >
            <div
              style={{
                backgroundColor: '#FFFFFF',
                borderRadius: '12px',
                padding: '32px',
                width: '95%',
                maxWidth: '1200px',
                maxHeight: '90vh',
                overflow: 'auto',
                boxShadow: '0 10px 40px rgba(0, 0, 0, 0.15)',
              }}
              onClick={(e) => e.stopPropagation()}
            >
              <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                marginBottom: '24px',
              }}>
                <h3 style={{
                  fontSize: '20px',
                  fontWeight: '600',
                  color: '#1A1A1A',
                  margin: 0,
                }}>
                  フィルター設定
                </h3>
                <button
                  type="button"
                  onClick={() => setShowFilterModal(false)}
                  style={{
                    padding: '8px',
                    backgroundColor: 'transparent',
                    border: 'none',
                    cursor: 'pointer',
                    borderRadius: '4px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                  }}
                >
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path
                      d="M15 5L5 15M5 5l10 10"
                      stroke="#6B7280"
                      strokeWidth="2"
                      strokeLinecap="round"
                    />
                  </svg>
                </button>
              </div>

              {/* 組織フィルター（階層ごと、ボタン形式） */}
              {(
              <div style={{ marginBottom: '32px' }}>
                <label style={{
                  display: 'block',
                  fontSize: '16px',
                  fontWeight: '600',
                  color: '#1A1A1A',
                  marginBottom: '20px',
                }}>
                  組織でフィルター
                </label>
                <div style={{
                  display: 'flex',
                  flexDirection: 'column',
                  gap: '24px',
                }}>
                  {hierarchyLevels.map(levelData => (
                    <div key={levelData.level}>
                      <div style={{
                        fontSize: '14px',
                        fontWeight: '600',
                        color: '#4262FF',
                        marginBottom: '12px',
                        paddingBottom: '8px',
                        borderBottom: '1px solid #F3F4F6',
                      }}>
                        レベル{levelData.level} ({levelData.orgs.length}組織)
                      </div>
                      <div style={{
                        display: 'flex',
                        flexWrap: 'wrap',
                        gap: '12px',
                        maxHeight: '300px',
                        overflowY: 'auto',
                        padding: '16px',
                        border: '1px solid #E5E7EB',
                        borderRadius: '8px',
                        backgroundColor: '#FAFAFA',
                      }}>
                        {levelData.orgs.map(org => {
                          const isSelected = filteredOrgIds.has(org.id);
                          return (
                            <button
                              key={org.id}
                              type="button"
                              onClick={() => {
                                const newFilteredOrgIds = new Set(filteredOrgIds);
                                if (isSelected) {
                                  newFilteredOrgIds.delete(org.id);
                                } else {
                                  newFilteredOrgIds.add(org.id);
                                }
                                setFilteredOrgIds(newFilteredOrgIds);
                              }}
                              style={{
                                padding: '12px 20px',
                                fontSize: '14px',
                                fontWeight: isSelected ? '600' : '400',
                                color: isSelected ? '#4262FF' : '#1A1A1A',
                                backgroundColor: isSelected ? '#F0F4FF' : '#FFFFFF',
                                border: isSelected ? '2px solid #4262FF' : '1.5px solid #E0E0E0',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                transition: 'all 150ms',
                                whiteSpace: 'nowrap',
                              }}
                              onMouseEnter={(e) => {
                                if (!isSelected) {
                                  e.currentTarget.style.borderColor = '#C4C4C4';
                                  e.currentTarget.style.backgroundColor = '#FAFAFA';
                                }
                              }}
                              onMouseLeave={(e) => {
                                if (!isSelected) {
                                  e.currentTarget.style.borderColor = '#E0E0E0';
                                  e.currentTarget.style.backgroundColor = '#FFFFFF';
                                }
                              }}
                            >
                              {org.name}
                            </button>
                          );
                        })}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
              )}

              {/* 事業会社モード: 組織フィルター（事業会社に紐づけられている組織） */}
              {viewMode === 'company' && (
                <div style={{ marginBottom: '32px' }}>
                  <label style={{
                    display: 'block',
                    fontSize: '16px',
                    fontWeight: '600',
                    color: '#1A1A1A',
                    marginBottom: '20px',
                  }}>
                    組織でフィルター（事業会社に紐づけられている組織）
                  </label>
                  <div style={{
                    display: 'flex',
                    flexDirection: 'column',
                    gap: '24px',
                  }}>
                    {hierarchyLevels.map(levelData => (
                      <div key={levelData.level}>
                        <div style={{
                          fontSize: '14px',
                          fontWeight: '600',
                          color: '#4262FF',
                          marginBottom: '12px',
                          paddingBottom: '8px',
                          borderBottom: '1px solid #F3F4F6',
                        }}>
                          レベル{levelData.level} ({levelData.orgs.length}組織)
                        </div>
                        <div style={{
                          display: 'flex',
                          flexWrap: 'wrap',
                          gap: '12px',
                          maxHeight: '300px',
                          overflowY: 'auto',
                          padding: '16px',
                          border: '1px solid #E5E7EB',
                          borderRadius: '8px',
                          backgroundColor: '#FAFAFA',
                        }}>
                          {levelData.orgs.map(org => {
                            // type='company'の組織のみ表示（事業会社モードの場合）
                            if (selectedTypeFilter === 'company') {
                              const findOrg = (node: OrgNodeData, targetId: string): OrgNodeData | null => {
                                if (node.id === targetId) return node;
                                if (node.children) {
                                  for (const child of node.children) {
                                    const found = findOrg(child, targetId);
                                    if (found) return found;
                                  }
                                }
                                return null;
                              };
                              const actualOrg = orgTree ? findOrg(orgTree, org.id) : null;
                              if (!actualOrg || (actualOrg as any).type !== 'company') return null;
                            }

                            const isSelected = filteredOrgIds.has(org.id);
                            return (
                              <button
                                key={org.id}
                                type="button"
                                onClick={() => {
                                  const newFilteredOrgIds = new Set(filteredOrgIds);
                                  const isAdding = !isSelected;
                                  
                                  if (isAdding) {
                                    newFilteredOrgIds.add(org.id);
                                  } else {
                                    newFilteredOrgIds.delete(org.id);
                                  }
                                  setFilteredOrgIds(newFilteredOrgIds);
                                  
                                  // 組織に紐づく事業会社も自動的に選択/解除
                                  // 事業会社の管理はorganizationsテーブルのtypeカラムで行うため、この処理は不要
                                  // const linkedCompanyIds = companies
                                  //   .filter(c => c.organizationId === org.id)
                                  //   .map(c => c.id);
                                  // 
                                  // const newFilteredCompanyIds = new Set(filteredCompanyIds);
                                  // if (isAdding) {
                                  //   // 組織を選択した場合、その組織に紐づく事業会社も選択
                                  //   linkedCompanyIds.forEach(companyId => {
                                  //     newFilteredCompanyIds.add(companyId);
                                  //   });
                                  // } else {
                                  //   // 組織を解除した場合、その組織に紐づく事業会社も解除
                                  //   linkedCompanyIds.forEach(companyId => {
                                  //     newFilteredCompanyIds.delete(companyId);
                                  //   });
                                  // }
                                  // setFilteredCompanyIds(newFilteredCompanyIds);
                                }}
                                style={{
                                  padding: '12px 20px',
                                  fontSize: '14px',
                                  fontWeight: isSelected ? '600' : '400',
                                  color: isSelected ? '#4262FF' : '#1A1A1A',
                                  backgroundColor: isSelected ? '#F0F4FF' : '#FFFFFF',
                                  border: isSelected ? '2px solid #4262FF' : '1.5px solid #E0E0E0',
                                  borderRadius: '8px',
                                  cursor: 'pointer',
                                  transition: 'all 150ms',
                                  whiteSpace: 'nowrap',
                                }}
                                onMouseEnter={(e) => {
                                  if (!isSelected) {
                                    e.currentTarget.style.borderColor = '#C4C4C4';
                                    e.currentTarget.style.backgroundColor = '#FAFAFA';
                                  }
                                }}
                                onMouseLeave={(e) => {
                                  if (!isSelected) {
                                    e.currentTarget.style.borderColor = '#E0E0E0';
                                    e.currentTarget.style.backgroundColor = '#FFFFFF';
                                  }
                                }}
                              >
                                {org.name}
                              </button>
                            );
                          })}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* 事業会社名フィルターは削除（typeで管理するため） */}

              {/* テーマフィルター（ボタン形式） */}
              <div style={{ marginBottom: '32px' }}>
                <label style={{
                  display: 'block',
                  fontSize: '16px',
                  fontWeight: '600',
                  color: '#1A1A1A',
                  marginBottom: '20px',
                }}>
                  テーマでフィルター
                </label>
                <div style={{
                  display: 'flex',
                  flexWrap: 'wrap',
                  gap: '12px',
                  maxHeight: '400px',
                  overflowY: 'auto',
                  padding: '16px',
                  border: '1px solid #E5E7EB',
                  borderRadius: '8px',
                  backgroundColor: '#FAFAFA',
                }}>
                  {themes.length === 0 ? (
                    <p style={{
                      fontSize: '13px',
                      color: '#6B7280',
                      width: '100%',
                      textAlign: 'center',
                      padding: '20px',
                    }}>
                      テーマが登録されていません
                    </p>
                  ) : (
                    themes.map(theme => {
                      const isSelected = filteredThemeIds.has(theme.id);
                      return (
                        <button
                          key={theme.id}
                          type="button"
                          onClick={() => {
                            const newFilteredThemeIds = new Set(filteredThemeIds);
                            if (isSelected) {
                              newFilteredThemeIds.delete(theme.id);
                            } else {
                              newFilteredThemeIds.add(theme.id);
                            }
                            setFilteredThemeIds(newFilteredThemeIds);
                          }}
                          style={{
                            padding: '12px 20px',
                            fontSize: '14px',
                            fontWeight: isSelected ? '600' : '400',
                            color: isSelected ? '#4262FF' : '#1A1A1A',
                            backgroundColor: isSelected ? '#F0F4FF' : '#FFFFFF',
                            border: isSelected ? '2px solid #4262FF' : '1.5px solid #E0E0E0',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            transition: 'all 150ms',
                            whiteSpace: 'nowrap',
                          }}
                          onMouseEnter={(e) => {
                            if (!isSelected) {
                              e.currentTarget.style.borderColor = '#C4C4C4';
                              e.currentTarget.style.backgroundColor = '#FAFAFA';
                            }
                          }}
                          onMouseLeave={(e) => {
                            if (!isSelected) {
                              e.currentTarget.style.borderColor = '#E0E0E0';
                              e.currentTarget.style.backgroundColor = '#FFFFFF';
                            }
                          }}
                        >
                          {theme.title}
                        </button>
                      );
                    })
                  )}
                </div>
              </div>

              {/* アクションボタン */}
              <div style={{
                display: 'flex',
                justifyContent: 'flex-end',
                gap: '12px',
                paddingTop: '16px',
                borderTop: '1px solid #E5E7EB',
              }}>
                <button
                  type="button"
                  onClick={() => {
                    setFilteredOrgIds(new Set());
                    setFilteredThemeIds(new Set());
                  }}
                  style={{
                    padding: '10px 20px',
                    fontSize: '14px',
                    fontWeight: '500',
                    color: '#6B7280',
                    backgroundColor: '#FFFFFF',
                    border: '1.5px solid #E0E0E0',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    transition: 'all 150ms',
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.borderColor = '#C4C4C4';
                    e.currentTarget.style.backgroundColor = '#FAFAFA';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.borderColor = '#E0E0E0';
                    e.currentTarget.style.backgroundColor = '#FFFFFF';
                  }}
                >
                  リセット
                </button>
                <button
                  type="button"
                  onClick={() => setShowFilterModal(false)}
                  style={{
                    padding: '10px 20px',
                    fontSize: '14px',
                    fontWeight: '500',
                    color: '#FFFFFF',
                    backgroundColor: '#4262FF',
                    border: 'none',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    transition: 'all 150ms',
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.backgroundColor = '#3151CC';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.backgroundColor = '#4262FF';
                  }}
                >
                  適用
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    </Layout>
  );
}

