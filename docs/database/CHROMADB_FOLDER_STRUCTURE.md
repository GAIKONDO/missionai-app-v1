# ChromaDBフォルダ構造の説明

## 概要

ChromaDBのデータディレクトリ（`chromadb`フォルダ）には、ベクトル埋め込みデータとメタデータが保存されています。このフォルダは、ChromaDBが内部的に使用するストレージ構造です。

## フォルダ構造

```
chromadb/
├── chroma.sqlite3                    # メタデータベース（SQLite）
├── 3b92de44-d...aecdab6d8db7/       # 埋め込みデータのセグメント（UUID）
│   ├── data_level0.bin              # ベクトルデータ（バイナリ）
│   ├── header.bin                   # ヘッダー情報
│   ├── length.bin                   # データ長情報
│   └── link_lists.bin               # リンクリスト
├── 698321af-e8...5ebf5be7d7b7/      # 別のセグメント
│   └── ...
└── ...                               # その他のセグメント
```

## 各ファイル・フォルダの役割

### 1. `chroma.sqlite3`（SQLiteデータベース）

**役割**: ChromaDBのメタデータを保存

**保存内容**:
- **コレクション定義**: `topics_{organizationId}`, `entities_{organizationId}`, `relations_{organizationId}`などのコレクション情報
- **ドキュメントID**: 埋め込みベクトルに対応するドキュメントID（例: `topicId`, `entityId`）
- **メタデータ**: `organizationId`, `meetingNoteId`, `title`, `content`などのメタデータ
- **インデックス情報**: ベクトル検索用のインデックス情報
- **設定情報**: ChromaDBの内部設定

**重要**: このファイルが破損すると、コレクション情報やメタデータが失われます。

### 2. UUID名のサブフォルダ（例: `3b92de44-d...aecdab6d8db7`）

**役割**: ベクトル埋め込みデータのセグメントとHNSWインデックスを保存

**保存内容**:
- **ベクトルデータ**: 実際の埋め込みベクトル（浮動小数点数の配列）
- **HNSWインデックス**: 高速な近似最近傍検索のための階層的グラフ構造
- **データ構造**: ChromaDBが内部的に使用するデータ構造

**特徴**:
- 各フォルダはUUIDで識別される（コレクションごとに生成）
- データ量に応じて複数のセグメントに分割される
- パフォーマンス最適化のため、データが分散保存される
- **ChromaDBの内部実装の一部**（直接操作不要）

**必要性**:
- ✅ **必要**: ChromaDBが正常に動作するために必須
- ✅ **自動管理**: ChromaDBが自動的に作成・削除・管理
- ❌ **直接操作不要**: ユーザーが直接削除・編集すべきではない

### 3. `.bin`ファイル（バイナリファイル）

#### `data_level0.bin`
- **役割**: 実際のベクトル埋め込みデータを保存
- **形式**: バイナリ形式（直接読み取り不可）
- **内容**: 浮動小数点数の配列（例: `[0.032, 0.024, -0.006, ...]`）

#### `header.bin`
- **役割**: セグメントのヘッダー情報を保存
- **内容**: データ構造の定義、バージョン情報など

#### `length.bin`
- **役割**: データセグメントの長さ情報を保存
- **内容**: 各ベクトルの次元数、データ長など

#### `link_lists.bin`
- **役割**: データチャンク間のリンク情報を保存
- **内容**: セグメント間の関連情報、インデックス情報など

## 現在の問題との関連

### 問題1: 埋め込みが不足している（580件/660件）

**原因**:
- ChromaDBに埋め込みが保存されていないトピックが存在
- `chroma.sqlite3`にはメタデータが存在するが、対応するベクトルデータ（`.bin`ファイル）が存在しない可能性

**確認方法**:
```bash
# chroma.sqlite3を確認
sqlite3 chromadb/chroma.sqlite3 "SELECT COUNT(*) FROM collections WHERE name LIKE 'topics_%';"
```

### 問題2: コレクション名のエラー（`topics_`）

**原因**:
- `organizationId`が空文字列の場合、コレクション名が`topics_`になる
- ChromaDBの命名規則に違反（末尾が`_`で終わる）

**影響**:
- `chroma.sqlite3`に不正なコレクション名が保存される可能性
- ベクトルデータの検索が失敗する

**確認方法**:
```bash
# 不正なコレクション名を確認
sqlite3 chromadb/chroma.sqlite3 "SELECT name FROM collections WHERE name LIKE '%_';"
```

## データの整合性チェック

### 1. SQLiteメタデータとベクトルデータの整合性

```sql
-- chroma.sqlite3でコレクション数を確認
SELECT name, COUNT(*) as count 
FROM collections 
GROUP BY name;

-- 各コレクションのドキュメント数を確認
SELECT collection_id, COUNT(*) as document_count
FROM embeddings
GROUP BY collection_id;
```

### 2. ベクトルデータの存在確認

- `chroma.sqlite3`にメタデータが存在するが、対応する`.bin`ファイルにベクトルデータが存在しない場合、データ不整合が発生している

## データのバックアップと復元

### バックアップ

```bash
# ChromaDBデータディレクトリ全体をバックアップ
cp -r chromadb chromadb_backup_$(date +%Y%m%d)

# または、tarで圧縮
tar -czf chromadb_backup_$(date +%Y%m%d).tar.gz chromadb/
```

### 復元

```bash
# バックアップから復元
cp -r chromadb_backup_YYYYMMDD chromadb

# または、tarから展開
tar -xzf chromadb_backup_YYYYMMDD.tar.gz
```

## データのクリーンアップ

### 注意事項

⚠️ **警告**: 以下の操作はデータを削除します。実行前に必ずバックアップを取ってください。

### 1. すべてのデータを削除（開発環境のみ）

```bash
# ChromaDBサーバーを停止
# データディレクトリを削除
rm -rf chromadb/

# アプリケーションを再起動すると、新しい空のデータディレクトリが作成される
```

### 2. 特定のコレクションのみ削除

ChromaDBのAPIを使用してコレクションを削除する必要があります（直接ファイルを削除しないでください）。

```rust
// Rust側のコード例
collection.delete().await?;
```

## トラブルシューティング

### 問題: `chroma.sqlite3`が破損している

**症状**:
- ChromaDBサーバーが起動しない
- コレクション情報が取得できない

**対処法**:
1. バックアップから復元
2. または、データを空にして再構築

### 問題: ベクトルデータが存在しない

**症状**:
- メタデータは存在するが、検索結果が空
- `similarity: 0`が返される

**対処法**:
1. 埋め込みを再生成
2. ChromaDBに再保存

### 問題: ディスク容量が不足

**症状**:
- ChromaDBサーバーが起動しない
- 書き込みエラーが発生

**対処法**:
1. 不要なコレクションを削除
2. 古いデータをアーカイブ
3. ディスク容量を確保

## 最適化のための推奨事項

### 1. 定期的なバックアップ

```bash
# 週次バックアップスクリプト
#!/bin/bash
BACKUP_DIR="~/backups/chromadb"
DATE=$(date +%Y%m%d)
tar -czf "$BACKUP_DIR/chromadb_$DATE.tar.gz" chromadb/
```

### 2. データ整合性チェック

定期的にSQLiteメタデータとベクトルデータの整合性をチェック

### 3. 不要なデータの削除

古いコレクションや使用されていない埋め込みデータを定期的に削除

## UUIDフォルダの必要性について

### Q: UUID名のサブフォルダって必要なの？

**A: はい、必要です。ただし、ユーザーが直接操作する必要はありません。**

### 詳細説明

#### 1. ChromaDBの内部実装の一部

UUIDフォルダは、ChromaDBが内部的に使用する**HNSW（Hierarchical Navigable Small World）インデックス**の一部です。

- **HNSWアルゴリズム**: 高速な近似最近傍検索を実現するための階層的グラフ構造
- **セグメント化**: 大量のデータを効率的に管理するため、複数のセグメントに分割
- **UUID識別**: 各セグメントを一意に識別するためにUUIDを使用

#### 2. 自動管理される

- **作成**: ChromaDBが自動的に作成（コレクション作成時、データ追加時）
- **削除**: ChromaDBが自動的に削除（コレクション削除時、データ削除時）
- **更新**: ChromaDBが自動的に更新（データ追加・更新時）

#### 3. 直接操作すべきではない

⚠️ **警告**: これらのフォルダを直接削除・編集すると、ChromaDBが正常に動作しなくなります。

**理由**:
- `chroma.sqlite3`とUUIDフォルダの整合性が崩れる
- HNSWインデックスが破損する
- ベクトル検索が失敗する

#### 4. データベース最適化時の扱い

**データを空にする場合**:
```bash
# ✅ 正しい方法: ChromaDBサーバーを停止してから、フォルダ全体を削除
# ChromaDBサーバーを停止
# アプリケーションを終了

# フォルダ全体を削除（UUIDフォルダも含む）
rm -rf chromadb/

# アプリケーションを再起動すると、新しい空の構造が作成される
```

**データを保持する場合**:
```bash
# ✅ 正しい方法: ChromaDBのAPIを使用してコレクションを管理
# UUIDフォルダは自動的に管理されるため、直接操作しない
```

**個別のUUIDフォルダを削除する場合**:
```bash
# ❌ 間違った方法: 個別のUUIDフォルダを直接削除
rm -rf chromadb/3b92de44-d...aecdab6d8db7/  # これは破損の原因になる

# ✅ 正しい方法: ChromaDBのAPIを使用してコレクションを削除
# Rust側のコード: collection.delete().await?
```

### まとめ

| 項目 | 説明 |
|------|------|
| **必要性** | ✅ 必要（ChromaDBの内部実装の一部） |
| **直接操作** | ❌ 不要（ChromaDBが自動管理） |
| **削除方法** | ChromaDBのAPIを使用（直接削除しない） |
| **最適化時** | フォルダ全体を削除するか、ChromaDBのAPIを使用 |

## まとめ

- **`chroma.sqlite3`**: メタデータベース（重要）
- **UUIDフォルダ**: ベクトルデータのセグメントとHNSWインデックス（必要、自動管理）
- **`.bin`ファイル**: バイナリ形式のベクトルデータ（必要、自動管理）

現在の問題（埋め込み不足、コレクション名エラー）は、この構造の不整合や設定ミスが原因の可能性があります。

データベース構造の最適化を進める際は、このフォルダの内容を理解しておくことが重要です。**UUIDフォルダは必要ですが、直接操作する必要はありません。**
