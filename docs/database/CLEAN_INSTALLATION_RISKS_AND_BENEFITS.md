# クリーンインストール（mission-ai-local-dev削除）のリスクとメリット

## 実行手順

1. ✅ データのバックアップを取得
2. 🗑️ `mission-ai-local-dev`の中身をすべて削除
3. 🆕 クリーンな状態のSQLiteとChromaDBをセッティング
4. 📋 必要なテーブルとカラムを作成

## メリット

### 1. **クリーンな状態から始められる** ⭐⭐⭐
- **古いデータの不整合がない**: 既存データの不整合を気にしなくて良い
- **新しいスキーマで開始**: 最適化されたスキーマで最初から構築できる
- **テストが容易**: クリーンな状態でのテストが可能

### 2. **マイグレーション処理が不要** ⭐⭐⭐
- **複雑な移行処理が不要**: データ移行スクリプトを実装する必要がない
- **実装時間の短縮**: マイグレーション処理の実装・テスト時間を節約
- **エラーリスクの低減**: データ移行時のエラーリスクがない

### 3. **パフォーマンスの最適化** ⭐⭐
- **インデックスの最適化**: 新しいインデックスを最初から適用できる
- **データ構造の最適化**: 最適化されたデータ構造で開始できる
- **ディスク容量の節約**: 不要なデータやインデックスがない

### 4. **開発速度の向上** ⭐⭐
- **迅速な開発**: データ移行処理を実装する時間を節約
- **シンプルな実装**: 新しいスキーマで直接実装できる
- **デバッグが容易**: クリーンな状態でのデバッグが容易

## リスク

### 1. **既存データの完全な喪失** ⚠️⚠️⚠️（高リスク）

#### リスク内容
- **すべてのデータが失われる**: エンティティ、リレーション、トピック、議事録など
- **復元が困難**: バックアップから復元する必要がある
- **テストデータの再生成**: テストデータを再生成する必要がある

#### 影響範囲
- SQLiteデータベース（`app.db`）
- ChromaDBデータ（`chromadb/`ディレクトリ）
- その他のファイル（画像など）

#### 対策
- ✅ **バックアップを取得済み**: リスクは軽減されている
- ✅ **開発環境**: 本番環境ではないため、影響は限定的
- ⚠️ **復元手順の確認**: バックアップからの復元手順を確認しておく

### 2. **初期化処理の依存関係** ⚠️⚠️（中リスク）

#### リスク内容
- **初期化処理の順序**: SQLiteとChromaDBの初期化順序が重要
- **テーブル作成の失敗**: 新しいスキーマでテーブル作成が失敗する可能性
- **外部キー制約**: テーブル間の依存関係によるエラー

#### 影響範囲
```rust
// 初期化処理の順序
1. init_database() → app.db作成 + テーブル作成
2. init_chromadb() → chromadb/ディレクトリ作成 + サーバー起動
```

#### 対策
- ✅ **既存の初期化処理を使用**: `init_database()`と`init_chromadb()`を使用
- ✅ **CREATE TABLE IF NOT EXISTS**: 既存のコードは安全に設計されている
- ⚠️ **エラーハンドリング**: 初期化エラー時のロールバック手順を準備

### 3. **デフォルトデータの再生成** ⚠️（低リスク）

#### リスク内容
- **デフォルトユーザーの作成**: `create_default_user()`が実行される
- **雛形データのインポート**: `import_template_data_if_empty()`が実行される
- **初期設定の再設定**: AI設定などの初期設定が必要

#### 影響範囲
```rust
// 初期化時に実行される処理
- create_default_user() // デフォルトユーザーの作成
- import_template_data_if_empty() // 雛形データのインポート
```

#### 対策
- ✅ **自動実行**: 既存のコードが自動的に処理する
- ⚠️ **設定の確認**: 初期設定（AI設定など）を確認する必要がある

### 4. **ChromaDBサーバーの起動** ⚠️（低リスク）

#### リスク内容
- **サーバー起動の失敗**: ChromaDBサーバーが起動しない可能性
- **ポート競合**: ポート8000が使用中の場合
- **Python環境**: ChromaDBがインストールされていない場合

#### 影響範囲
- ChromaDBサーバーの起動
- ベクトル検索機能

#### 対策
- ✅ **既存のエラーハンドリング**: 既存のコードにエラーハンドリングがある
- ⚠️ **環境の確認**: Python環境とChromaDBのインストールを確認

### 5. **アプリケーションの再起動が必要** ⚠️（低リスク）

#### リスク内容
- **データベース接続の切断**: アプリケーション実行中に削除するとエラーが発生
- **ChromaDBサーバーの停止**: 実行中のサーバーを停止する必要がある

#### 影響範囲
- アプリケーションの動作
- データベース接続

#### 対策
- ✅ **アプリケーションを停止**: 削除前にアプリケーションを停止
- ✅ **ChromaDBサーバーを停止**: サーバーを停止してから削除

## 実行時の注意事項

### 1. **アプリケーションの停止**

```bash
# 1. アプリケーションを完全に終了
# 2. ChromaDBサーバーが実行中でないことを確認
ps aux | grep chroma
```

### 2. **バックアップの確認**

```bash
# バックアップが正しく取得されていることを確認
ls -lh ~/backups/mission-ai-local-dev_YYYYMMDD/
```

### 3. **ディレクトリの削除**

```bash
# macOSの場合
rm -rf ~/Library/Application\ Support/mission-ai-local-dev/

# または、特定のファイルのみ削除
rm -rf ~/Library/Application\ Support/mission-ai-local-dev/app.db
rm -rf ~/Library/Application\ Support/mission-ai-local-dev/chromadb/
```

### 4. **アプリケーションの再起動**

```bash
# アプリケーションを再起動
# 自動的に初期化処理が実行される
```

## 推奨される実行手順

### ステップ1: 準備

1. ✅ **バックアップの確認**
   ```bash
   # バックアップが存在することを確認
   ls -lh ~/backups/mission-ai-local-dev_YYYYMMDD/
   ```

2. ✅ **アプリケーションの停止**
   - アプリケーションを完全に終了
   - ChromaDBサーバーが実行中でないことを確認

3. ✅ **環境の確認**
   - Python環境がインストールされているか確認
   - ChromaDBがインストールされているか確認

### ステップ2: 削除

1. 🗑️ **ディレクトリの削除**
   ```bash
   # macOSの場合
   rm -rf ~/Library/Application\ Support/mission-ai-local-dev/
   ```

2. ✅ **削除の確認**
   ```bash
   # ディレクトリが削除されたことを確認
   ls ~/Library/Application\ Support/mission-ai-local-dev/ 2>&1
   # エラー（存在しない）が表示されればOK
   ```

### ステップ3: 初期化

1. 🆕 **アプリケーションの起動**
   - アプリケーションを起動
   - 自動的に初期化処理が実行される

2. ✅ **初期化の確認**
   - ログを確認して初期化が成功したことを確認
   - データベースファイルが作成されたことを確認
   - ChromaDBサーバーが起動したことを確認

### ステップ4: 新しいスキーマの適用

1. 📋 **テーブル作成**
   - 新しいスキーマでテーブルを作成
   - インデックスを追加

2. ✅ **動作確認**
   - 基本的な操作（作成、読み取り、更新、削除）をテスト
   - RAG検索をテスト

## リスク軽減策

### 1. **段階的な実行**

```bash
# ステップ1: SQLiteのみ削除（テスト）
rm ~/Library/Application\ Support/mission-ai-local-dev/app.db

# ステップ2: アプリケーションを起動して確認
# ステップ3: 問題がなければ、ChromaDBも削除
rm -rf ~/Library/Application\ Support/mission-ai-local-dev/chromadb/
```

### 2. **ロールバック計画**

```bash
# 問題が発生した場合のロールバック
# バックアップから復元
cp -r ~/backups/mission-ai-local-dev_YYYYMMDD/* \
     ~/Library/Application\ Support/mission-ai-local-dev/
```

### 3. **テスト環境での実行**

- まずテスト環境で実行して確認
- 問題がなければ本番環境（開発環境）で実行

## まとめ

### メリットの評価

| メリット | 重要度 | 評価 |
|---------|--------|------|
| クリーンな状態から始められる | ⭐⭐⭐ | 高 |
| マイグレーション処理が不要 | ⭐⭐⭐ | 高 |
| パフォーマンスの最適化 | ⭐⭐ | 中 |
| 開発速度の向上 | ⭐⭐ | 中 |

### リスクの評価

| リスク | 重要度 | 対策 |
|--------|--------|------|
| 既存データの完全な喪失 | ⚠️⚠️⚠️ | バックアップ取得済み ✅ |
| 初期化処理の依存関係 | ⚠️⚠️ | 既存の初期化処理を使用 ✅ |
| デフォルトデータの再生成 | ⚠️ | 自動実行される ✅ |
| ChromaDBサーバーの起動 | ⚠️ | 環境の確認が必要 ⚠️ |
| アプリケーションの再起動 | ⚠️ | 停止してから削除 ✅ |

### 推奨判断

**✅ 実行を推奨**（開発環境の場合）

**理由**:
1. バックアップを取得済み（リスクが軽減されている）
2. 開発環境（本番データではない）
3. メリットがリスクを上回る
4. 既存の初期化処理が安全に設計されている

**注意事項**:
- アプリケーションを停止してから削除
- 初期化処理のログを確認
- 問題が発生した場合はバックアップから復元
